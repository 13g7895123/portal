openapi: 3.0.3
info:
  title: CRM 認證 API 契約
  description: |
    CRM 登入整合功能使用的認證 API 端點契約定義。

    本契約定義前端應用程式與 CRM 認證服務之間的介面，包含：
    - 使用者登入 (POST /auth/login)
    - 使用者登出 (POST /auth/logout)
    - Token 刷新 (POST /auth/refresh)
    - 取得當前使用者資訊 (GET /auth/me)

    **契約測試範圍**: 本檔案用於產生契約測試，驗證 CRM API 符合規格。
  version: 1.0.0
  contact:
    name: 前端開發團隊
  license:
    name: MIT

servers:
  - url: http://localhost:8080/api/v1
    description: 本地開發環境
  - url: http://localhost:9230/api/v1
    description: Docker 開發環境
  - url: https://staging-crm.example.com/api/v1
    description: 測試環境
  - url: https://crm.example.com/api/v1
    description: 正式環境

tags:
  - name: Authentication
    description: 認證端點（登入、登出、token 管理）

security:
  - BearerAuth: []

paths:
  # ============================================================================
  # 登入端點
  # ============================================================================

  /auth/login:
    post:
      tags:
        - Authentication
      summary: 使用者登入
      description: |
        使用帳號密碼進行身份驗證，成功後返回 access_token 和 refresh_token。

        **行為**:
        - 驗證帳號和密碼
        - 成功時返回 access_token (1 小時有效)
        - 在 HttpOnly cookie 中設定 refresh_token
        - 返回使用者基本資訊

        **錯誤處理**:
        - 401: 帳號或密碼錯誤
        - 422: 輸入格式驗證失敗
        - 429: 登入嘗試過於頻繁（後端實作的速率限制）
      security: []  # 登入不需要認證
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 50
                  description: 使用者帳號
                  example: testuser
                password:
                  type: string
                  format: password
                  minLength: 8
                  description: 使用者密碼
                  example: password123
                rememberMe:
                  type: boolean
                  description: 是否記住登入（影響 refresh_token 有效期：false = session, true = 30 天）
                  default: false
                  example: false
            examples:
              基本登入:
                value:
                  username: testuser
                  password: password123
                  rememberMe: false
              記住我登入:
                value:
                  username: testuser
                  password: password123
                  rememberMe: true
      responses:
        '200':
          description: 登入成功
          headers:
            Set-Cookie:
              description: |
                HttpOnly cookie 包含 refresh_token

                格式: `refresh_token={token}; HttpOnly; Secure; SameSite=Strict; Max-Age={有效秒數}`
              schema:
                type: string
                example: refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=2592000
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - data
                properties:
                  status:
                    type: string
                    enum: [success]
                    description: 回應狀態
                    example: success
                  data:
                    type: object
                    required:
                      - access_token
                      - refresh_token
                      - token_type
                      - expires_in
                      - user
                    properties:
                      access_token:
                        type: string
                        description: JWT 存取令牌（儲存於 sessionStorage）
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ0ZXN0dXNlciIsImV4cCI6MTcwNjAwMTIzNH0.xxx
                      refresh_token:
                        type: string
                        description: 更新令牌（也會在 HttpOnly cookie 中設定）
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidHlwZSI6InJlZnJlc2giLCJleHAiOjE3MDg1OTMyMzR9.yyy
                      token_type:
                        type: string
                        enum: [Bearer]
                        description: Token 類型（固定為 Bearer）
                        example: Bearer
                      expires_in:
                        type: integer
                        description: Access token 有效秒數（通常 3600 = 1 小時）
                        example: 3600
                      user:
                        $ref: '#/components/schemas/UserInfo'
              examples:
                成功登入:
                  value:
                    status: success
                    data:
                      access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      refresh_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      token_type: Bearer
                      expires_in: 3600
                      user:
                        id: 1
                        username: testuser
                        email: test@example.com
                        fullName: 測試使用者
                        department: IT
                        region: TW
                        isActive: true
                        lastLoginAt: "2025-01-24T10:30:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          description: 登入嘗試過於頻繁
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                message: 登入嘗試過於頻繁，請稍後再試
                code: 429

  # ============================================================================
  # 登出端點
  # ============================================================================

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: 使用者登出
      description: |
        使當前 access_token 失效並清除 refresh_token cookie。

        **行為**:
        - 將當前 access_token 加入黑名單（後端實作）
        - 清除 refresh_token HttpOnly cookie
        - 返回成功訊息

        **注意**: 前端需同時清除 sessionStorage 的 access_token 和 Pinia store 的認證狀態。
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 登出成功
          headers:
            Set-Cookie:
              description: 清除 refresh_token cookie
              schema:
                type: string
                example: refresh_token=; HttpOnly; Secure; SameSite=Strict; Max-Age=0
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - message
                properties:
                  status:
                    type: string
                    enum: [success]
                    example: success
                  message:
                    type: string
                    description: 成功訊息
                    example: 登出成功
              example:
                status: success
                message: 登出成功
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============================================================================
  # Token 刷新端點
  # ============================================================================

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: 刷新 access token
      description: |
        使用 refresh_token 獲取新的 access_token。

        **行為**:
        - 從 HttpOnly cookie 讀取 refresh_token
        - 驗證 refresh_token 有效性
        - 返回新的 access_token
        - 原 refresh_token 保持不變（除非即將過期）

        **使用場景**:
        - 前端偵測到 access_token 剩餘有效時間 < 5 分鐘時自動呼叫
        - API 請求收到 401 錯誤時由 Axios interceptor 自動呼叫

        **注意**: refresh_token 在 HttpOnly cookie 中，瀏覽器會自動附加到請求。
      security: []  # 不使用 Bearer token，依賴 HttpOnly cookie
      requestBody:
        required: false
        description: 可選：若 refresh_token 未在 cookie 中，可在 body 提供
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  description: Refresh token（通常從 cookie 自動取得，body 為備用方案）
      responses:
        '200':
          description: Token 刷新成功
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - data
                properties:
                  status:
                    type: string
                    enum: [success]
                    example: success
                  data:
                    type: object
                    required:
                      - access_token
                      - token_type
                      - expires_in
                    properties:
                      access_token:
                        type: string
                        description: 新的 JWT 存取令牌
                        example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      token_type:
                        type: string
                        enum: [Bearer]
                        example: Bearer
                      expires_in:
                        type: integer
                        description: 新 token 有效秒數
                        example: 3600
              example:
                status: success
                data:
                  access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  token_type: Bearer
                  expires_in: 3600
        '401':
          description: Refresh token 無效或過期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                message: Refresh token 無效或已過期，請重新登入
                code: 401

  # ============================================================================
  # 取得當前使用者端點
  # ============================================================================

  /auth/me:
    get:
      tags:
        - Authentication
      summary: 取得當前使用者資訊
      description: |
        取得已認證使用者的基本資料。

        **行為**:
        - 驗證 Authorization header 中的 access_token
        - 返回 token 對應的使用者資訊

        **使用場景**:
        - 登入成功後通常已從 /auth/login 取得 user，不需額外呼叫
        - 僅在需要重新驗證或取得最新資料時使用
      security:
        - BearerAuth: []
      responses:
        '200':
          description: 成功取得使用者資訊
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                properties:
                  data:
                    $ref: '#/components/schemas/UserInfo'
              example:
                data:
                  id: 1
                  username: testuser
                  email: test@example.com
                  fullName: 測試使用者
                  department: IT
                  region: TW
                  isActive: true
                  lastLoginAt: "2025-01-24T10:30:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'

# ==============================================================================
# 元件定義
# ==============================================================================

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token 認證。

        **使用方式**:
        ```
        Authorization: Bearer {access_token}
        ```

        **Token 來源**: sessionStorage['access_token'].token

  schemas:
    UserInfo:
      type: object
      required:
        - id
        - username
        - email
        - isActive
      properties:
        id:
          type: integer
          description: 使用者 ID（唯一識別）
          example: 1
        username:
          type: string
          description: 使用者帳號
          example: testuser
        email:
          type: string
          format: email
          description: 電子郵件地址
          example: test@example.com
        fullName:
          type: string
          nullable: true
          description: 使用者全名
          example: 測試使用者
        department:
          type: string
          nullable: true
          description: 使用者部門
          example: IT
        region:
          type: string
          nullable: true
          description: 使用者地區
          example: TW
        isActive:
          type: boolean
          description: 帳號是否啟用
          example: true
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
          description: 最後登入時間（ISO 8601 格式）
          example: "2025-01-24T10:30:00Z"

    ErrorResponse:
      type: object
      required:
        - status
        - message
        - code
      properties:
        status:
          type: string
          enum: [error]
          description: 錯誤狀態（固定為 error）
          example: error
        message:
          type: string
          description: 錯誤訊息（繁體中文）
          example: 帳號或密碼錯誤
        code:
          type: integer
          description: HTTP 狀態碼
          example: 401
        errors:
          type: object
          description: 詳細錯誤欄位（用於驗證錯誤）
          additionalProperties:
            type: array
            items:
              type: string
          example:
            username: ["帳號為必填欄位"]
            password: ["密碼長度至少 8 字元"]

  responses:
    Unauthorized:
      description: 未授權 - Token 無效或已過期
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            Token 過期:
              value:
                status: error
                message: Token 已過期
                code: 401
            Token 無效:
              value:
                status: error
                message: Token 無效
                code: 401
            帳號密碼錯誤:
              value:
                status: error
                message: 帳號或密碼錯誤
                code: 401

    ValidationError:
      description: 驗證錯誤 - 輸入資料格式不正確
      content:
        application/json:
          schema:
            type: object
            required:
              - status
              - message
              - errors
            properties:
              status:
                type: string
                enum: [error]
                example: error
              message:
                type: string
                description: 總體錯誤訊息
                example: 驗證失敗
              errors:
                type: object
                description: 各欄位的錯誤訊息
                additionalProperties:
                  type: array
                  items:
                    type: string
          examples:
            登入驗證失敗:
              value:
                status: error
                message: 驗證失敗
                errors:
                  username: ["帳號為必填欄位", "帳號長度必須在 3-50 字元之間"]
                  password: ["密碼為必填欄位", "密碼長度至少 8 字元"]

# ==============================================================================
# 契約測試指南
# ==============================================================================

# 本 OpenAPI 規格用於產生契約測試，驗證 CRM API 符合定義。
#
# 測試檔案: frontend/tests/contract/crm-auth-api.test.ts
#
# 測試範圍:
# 1. POST /auth/login
#    - 成功登入（200 + access_token + refresh_token + user）
#    - 帳號密碼錯誤（401）
#    - 輸入驗證失敗（422）
# 2. POST /auth/logout
#    - 成功登出（200 + 清除 cookie）
#    - 未認證（401）
# 3. POST /auth/refresh
#    - 成功刷新（200 + 新 access_token）
#    - Refresh token 無效（401）
# 4. GET /auth/me
#    - 成功取得使用者資訊（200 + user）
#    - 未認證（401）
#
# 測試工具: Vitest + MSW (Mock Service Worker)
# 參考: `docs/openapi.yaml` (完整 CRM API 規格)
